# Auto-fee - 인바운드 수수료 모듈 (할인)

### ⚙️ 주요 파라미터

```python
INBOUND_FEE_ENABLE = True
```

* **정의:** 인바운드 할인의 마스터 스위치.
* **True인 경우:** 스크립트는 인바운드 수수료 할인을 계산하고 적용합니다.
* **False인 경우:** 인바운드를 무시하고 할인을 변경하지 않습니다.

---

```python
INBOUND_FEE_SINK_ONLY = True
```

* **정의:** 인바운드 할인을 적용할 수 있는 **채널**을 정의합니다.
* **True인 경우:** `sink`로 분류된 채널에만 적용 (많은 sats를 밖으로 보내는 경향이 있는 채널).
* **False인 경우:** 로직이 허용하는 경우 다른 채널 유형 (source/router)에도 적용 가능.

*실무:* 인바운드 "할인"이 가장 영향력이 있는 곳이 sinks이므로 `True`로 유지.

---

```python
INBOUND_FEE_PASSIVE_REBAL_MODE = True
```

* **정의:** **지능형 수동 리밸런스** 모드를 활성화합니다.
* **True인 경우:**

  * 존재할 때 **실제 7d rebal 비용**을 앵커로 사용.
  * **rebal 7d 없는 드레인된 sinks**의 특수 로직도 활성화 (공격적 할인).
* **False인 경우:**

  * "추정" 비용만 기반으로 더 보수적인 동작, 공격적/수동 모드 없음.

*번역:* 실제 rebal 비용으로 수동 rebalance 할인을 테스트하고 싶으신가요? `True` 유지.

---

```python
INBOUND_FEE_MIN_FWDS_7D = 5
```

* **정의:** **리베이트 적용을 고려하기 위한** 지난 7일간의 최소 forwards 수.
* **적용되는 위치:** 일반적인 인바운드 로직 (rebal/비용/마진 포함 sinks).
* **예외:** **rebal 7d가 없는 매우 드레인된 sink**의 특수 경우에는 필요하지 않습니다.

*실무:*

* 아무도 사용하지 않는 채널에서 인바운드를 최적화하지 않으려고 하나요? 5 유지 또는 올리세요.
* 사용량이 적더라도 더 공격적이기를 원하시나요? 이 숫자를 줄이세요.

---

```python
INBOUND_FEE_MIN_MARGIN_PPM = 200
```

* **정의:** 할인을 주기 시작하기 위한 최소 마진 (ppm, 지난 7일간).
* **작동 방식:**

  * 7d 마진 (인바운드 수수료 − rebal 비용) < 200 ppm인 경우, 스크립트는 **인바운드 할인을 주지 않습니다** (일반 경로에서).
* **적용되지 않는 곳:** **"drained-no-rebal"** 모드 (실제 rebal 없는 매우 드레인된 sink)에서는 이 필터가 무시됩니다.

*실무:*

* 이것은 **충분히 수익성이 없는** 채널에서 할인을 주는 것을 방지합니다.

---

```python
INBOUND_FEE_SHARE_OF_MARGIN = 0.30
```

* **정의:** 마진의 어느 부분이 인바운드 할인이 되는가.
* **예:**

  * 7d 마진 = 1000 ppm
  * `INBOUND_FEE_SHARE_OF_MARGIN = 0.30` → 할인 = 300 ppm
* **일반 모드**에만 적용 (드레인된/수동 모드 아님).

*아이디어:* 수익의 일부를 유동성을 다시 보내는 사람과 "공유"합니다.

---

```python
INBOUND_FEE_MAX_FRAC_LOCAL = 0.90
```

* **정의:** 로컬 수수료에 대한 할인의 상대 한계.
* **예:**

  * `local_ppm = 2000`, `MAX_FRAC_LOCAL = 0.9` → 최대 할인 = 1800 ppm.
* **일반 모드** 및 **drained-no-rebal** 모드 모두에 적용.

*기능:* 제어 없이 **거의 전체** 할인을 주는 것을 보장하지 않습니다.

---

```python
INBOUND_FEE_MIN_OVER_REBAL_FRAC = 1.002
```

* **정의:** rebal 비용 위의 안전 쿠션.
* **작동 방식:**

  * net_fee (할인 후)는 ≥ `cost_rebal * 1.002`여야 합니다.
  * 즉, 항상 비용보다 **약간 위에** (반올림으로 인한 0 또는 손실 회피).

*"2 sats로 어리석은 짓하지 마세요" 시스템입니다* 😅

---

```python
INBOUND_FEE_PUSH_MIN_ABS_PPM = 10
```

* **정의:** 인바운드 할인에서 **BOS/LND로 업데이트를 보낼** 최소 변동.
* **예:**

  * 인바운드가 500 → 504 ppm으로 변경되면 한계 10과 함께, **업데이트를 보내지 않습니다**.
  * 마이크로 변동으로 인한 업데이트 이탈을 줄입니다.

---

### 💧 특수 모드: rebal 7d가 없는 매우 드레인된 sinks

```python
INBOUND_FEE_DRAINED_NO_REBAL_ENABLE   = True
```

* **정의:** "수동 리밸런스 공격" 모드를 켜/끕니다.
* **True인 경우:**

  * 매우 드레인된 sinks, rebal 7d 없음, 로컬 수수료 기반 강력한 할인 적용.
* **False인 경우:**

  * 이 채널들이 나머지처럼 처리됨 (또는 필터에 따라 인바운드 할인을 받지 않음).

---

```python
INBOUND_FEE_DRAINED_OUT_RATIO_MAX = 0.05
```

* **정의:** **매우 드레인된** sink가 무엇인지 정의합니다.
* **out_ratio ≤ 0.05 (5%)** 및 rebal 7d 실제 없음 → 이 특수 모드 진입.

*번역:* 채널이 당신 쪽에서 거의 말라있습니다.

---

```python
INBOUND_FEE_DRAINED_DISCOUNT_FRAC = 0.70
```

* **정의:** 드레인된/수동 모드에서 로컬 수수료의 몇 퍼센트를 할인으로 사용.
* **예:**

  * `local_ppm = 3000`, 분수 = 0.7 → 할인 = 2100 ppm
  * 최종 인바운드 ≈ 900 ppm

*여기서 이 버려진 sinks에서 유동성을 매력적으로 할 얼마나 공격적인지 제어합니다.*

---

```python
INBOUND_FEE_OUT_RATIO_MAX = 0.10
```

* **정의:** 채널을 "**인바운드용 저 아웃바운드**"로 간주할 아웃바운드 한계.
* **out_ratio > 0.10:** 인바운드 할인의 게임에 진입하지 않습니다.
* **out_ratio ≤ 0.10:** 채널은 할인을 생각할 수 있을 정도로 드레인되어 간주됨.

*중요한 차이:*

* `INBOUND_FEE_OUT_RATIO_MAX` = 인바운드 목적상 "저 아웃바운드/드레인된" 채널의 일반 게이트.
* `INBOUND_FEE_DRAINED_OUT_RATIO_MAX` = 여전히 더 중대한 부분 집합 (매우 드레인됨) 공격적 수동 모드용.

### 비교할 프로필

1. **rebal 7d 포함 수익성 있는 sink**
2. **rebal 7d 없는 매우 드레인된 sink (수동 리밸런스)**
3. **"미온적" 채널 (충분히 드레인되지 않음)** → 인바운드 할인 **밖**

---

### 🧮 파라미터별 동작 테이블

| 파라미터                             | Sink 수익성 있음 w/ rebal 7d 실제                                                                                                     | Sink 드레인됨 w/o rebal 7d 실제 (수동)                                                                                     | 채널 미온적 (밖)                                                                                |
| ------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| `INBOUND_FEE_ENABLE`                  | **어떤 할인이든 존재하려면 True여야 함**                                                                               | **True여야 함**                                                                                      | False인 경우 아무도 할인을 받지 않음                                                                 |
| `INBOUND_FEE_SINK_ONLY`               | True인 경우, `sink`로 분류된 경우만 적용                                                                          | 또한 `sink`여야 함                                                                                   | sink가 아닌 경우 이미 제외됨                                                               |
| `INBOUND_FEE_PASSIVE_REBAL_MODE`      | True인 경우, 실제 7d rebal 비용이 존재할 때 앵커                                                                            | **필수**: "drained-no-rebal" 모드 활성화                                                       | False인 경우 이 특수 모드는 절대 진입하지 않음                                                          |
| `INBOUND_FEE_MIN_FWDS_7D`             | **사용됨**: 최소 이 숫자의 7d forwards 필요                                                                                                  | **무시됨** 이 모드에서 (0 fwds일 수 있음)                                                                   | 달성하지 못하고 "drained-no-rebal" 진입 안 함 → `few-fwds`로 제외                              |
| `INBOUND_FEE_MIN_MARGIN_PPM`          | **사용됨**: 할인은 7d 마진 ≥ 이 값인 경우만                                                                                                  | **드레인된/수동 모드에서 무시됨**                                                                        | 달성하지 못하고 특수 모드 진입 안 함 → 할인 없음                                                  |
| `INBOUND_FEE_SHARE_OF_MARGIN`         | **사용됨**: 마진의 분수가 인바운드 할인이 됨                                                                            | 사용되지 않음 (할인은 로컬 수수료 기반, 마진 아님)                                          | 채널이 인바운드 로직 앞에서 필터링되면 효과 없음                                                        |
| `INBOUND_FEE_MAX_FRAC_LOCAL`          | **한계** 로컬 수수료에 대한 상대 할인                                                                                          | **한계** 여기서도: 공격적 모드에서도 이것을 통과하지 않음                                              | 채널이 인바운드 로직에 진입하지 않으면 사용되지 않음                                                       |
| `INBOUND_FEE_MIN_OVER_REBAL_FRAC`     | net_fee ≥ cost_rebal × 안전 요소 보장                                                                              | 비용 앵커가 있으면 여전히 존중; 하지만 순수 드레인 모드에서는 초점이 `price_ppm` 더                            | 인바운드 할인이 없으면 작동하지 않음                                                      |
| `INBOUND_FEE_PUSH_MIN_ABS_PPM`        | 변경이 BOS 업데이트 한계 < 경우 재전송 회피                                                                            | 동일한 동작                                                                                         | 할인이 없으면 인바운드 푸시도 없음                                                   |
| `INBOUND_FEE_DRAINED_NO_REBAL_ENABLE` | 직접적 영향 없음 (실제 rebal 7d **있으므로**)                                                                                                            | **핵심**: True인 경우 이 프로필에 대한 공격적 할인 모드 활성화                           | True여도 채널이 충분히 드레인되지 않으면 진입하지 않음                                  |
| `INBOUND_FEE_DRAINED_OUT_RATIO_MAX`   | 적용되지 않음: 채널이 아직 드레인될 수 있지만 특수 모드는 **실제 rebal 없을** 때만 봄 | **"매우 드레인됨" 기준**: `out_ratio ≤ 이 값`                                                   | 이것 위에 `out_ratio` → "drained-no-rebal" 모드 진입 안 함                                  |
| `INBOUND_FEE_OUT_RATIO_MAX`           | `out_ratio > INBOUND_FEE_OUT_RATIO_MAX` → 채널이 "드레인되지 않음" 간주 및 인바운드 할인 받지 않음                    | 또한 `out_ratio ≤ INBOUND_FEE_OUT_RATIO_MAX` 필요 적격                              | **주요 필터** "미온적 채널": `out_ratio >` 이 한계 → 인바운드 밖 |
| `INBOUND_FEE_DRAINED_DISCOUNT_FRAC`   | 여기서 사용되지 않음 (할인은 마진에서 옴)                                                                                            | **수동 모드의 핵심**: 할인 ≈ `price_ppm * 이_요소` (by `INBOUND_FEE_MAX_FRAC_LOCAL`)                      | 채널이 ratio/forwards/etc로 앞에서 필터링되면 작동하지 않음                         |
